# .github/workflows/live-analysis.yml
name: Live Analysis with AI

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'URL da live para analisar'
        required: true
        type: string
      duration_minutes:
        description: 'Duração da live em minutos'
        required: true
        type: number

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      segments: ${{ steps.generate-segments.outputs.segments }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate segment list
        id: generate-segments
        run: |
          duration=${{ github.event.inputs.duration_minutes }}
          segments="["
          for ((i=0; i<duration; i++)); do
            if [ $i -gt 0 ]; then
              segments="$segments,"
            fi
            segments="$segments$i"
          done
          segments="$segments]"
          echo "segments=$segments" >> $GITHUB_OUTPUT

  analyze:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        segment: ${{ fromJson(needs.setup.outputs.segments) }}
        account_id: [0, 1, 2, 3, 4]
      max-parallel: 5
      fail-fast: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install playwright ffmpeg-static
          npx playwright install chromium

      - name: Download video segment
        run: |
          # Instalar yt-dlp para baixar o segmento
          pip install yt-dlp
          
          # Baixar segmento específico de 1 minuto
          start_time=$((${{ matrix.segment }} * 60))
          yt-dlp -f best --external-downloader ffmpeg --external-downloader-args "-ss $start_time -t 60" \
            -o "segment_${{ matrix.segment }}.%(ext)s" \
            "${{ github.event.inputs.video_url }}"
          
          # Converter para MP4 se necessário
          if [ ! -f "segment_${{ matrix.segment }}.mp4" ]; then
            ffmpeg -i segment_${{ matrix.segment }}.* -c copy segment_${{ matrix.segment }}.mp4
          fi

      - name: Analyze segment with AI
        run: node analyze-segment.js ${{ matrix.segment }} ${{ matrix.account_id }}
        env:
          SEGMENT_FILE: segment_${{ matrix.segment }}.mp4

      - name: Upload analysis result
        uses: actions/upload-artifact@v4
        with:
          name: analysis-segment-${{ matrix.segment }}
          path: analysis_${{ matrix.segment }}.txt

      - name: Clean up segment file
        run: rm -f segment_${{ matrix.segment }}.*

  compile-timeline:
    runs-on: ubuntu-latest
    needs: [setup, analyze]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all analysis results
        uses: actions/download-artifact@v4
        with:
          pattern: analysis-segment-*
          merge-multiple: true

      - name: Compile timeline
        run: node compile-timeline.js ${{ github.event.inputs.duration_minutes }}

      - name: Upload final timeline
        uses: actions/upload-artifact@v4
        with:
          name: live-timeline
          path: |
            timeline.txt
            timeline.json
